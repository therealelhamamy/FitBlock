<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitBlock</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, sans-serif;
            background: #0A0E27;
            color: #fff;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 80px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 15px;
            overflow-y: auto;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            position: sticky;
            top: 0;
            background: #0A0E27;
            z-index: 10;
        }

        .logo {
            font-size: 32px;
            font-weight: 900;
            background: linear-gradient(135deg, #FF3B30, #00D4FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .time-bank {
            background: rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }

        .time-display {
            font-size: 48px;
            font-weight: 900;
            color: #00D4FF;
        }

        .screen {
            display: none;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .screen.active {
            display: block;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            margin: 10px 0;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FF3B30, #FF6B30);
            color: white;
        }

        .btn-success {
            background: #34C759;
            color: white;
        }

        .app-item {
            background: rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 14px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-item.blocked {
            border: 2px solid #FF3B30;
        }

        .toggle {
            width: 48px;
            height: 28px;
            background: #555;
            border-radius: 14px;
            position: relative;
        }

        .toggle.active {
            background: #FF3B30;
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: white;
            top: 3px;
            left: 3px;
            transition: 0.3s;
        }

        .toggle.active::after {
            left: 23px;
        }

        .camera-container {
            position: relative;
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            background: #000;
            display: none;
        }

        .camera-container.active {
            display: block;
        }

        #video {
            width: 100%;
            transform: scaleX(-1);
        }

        .rep-counter {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 12px 30px;
            border-radius: 25px;
            border: 2px solid #00D4FF;
        }

        .rep-count {
            font-size: 36px;
            font-weight: 900;
            color: #00D4FF;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10,14,39,0.98);
            padding: 12px;
            display: flex;
            justify-content: space-around;
            z-index: 100;
        }

        .nav-item {
            text-align: center;
            padding: 5px 15px;
        }

        .nav-item.active {
            color: #00D4FF;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">FITBLOCK</div>
        </div>

        <div class="time-bank">
            <div class="time-display" id="timeDisplay">0</div>
            <div>Minutes Available</div>
        </div>

        <!-- Home Screen -->
        <div id="homeScreen" class="screen active">
            <button class="btn btn-primary" onclick="pickApp()">+ Add Apps to Block</button>
            <div id="appList"></div>
        </div>

        <!-- Exercise Screen -->
        <div id="exerciseScreen" class="screen">
            <h2 id="exerciseTitle">Exercise</h2>
            <div class="camera-container" id="cameraContainer">
                <video id="video" autoplay playsinline></video>
                <div class="rep-counter">
                    <div class="rep-count" id="repCount">0</div>
                </div>
            </div>
            <button class="btn btn-success" onclick="completeExercise()">Finish (+<span id="earnedMins">0</span> min)</button>
            <button class="btn" style="background:#555" onclick="stopExercise()">Cancel</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="showScreen('homeScreen')">
            üè†<br><small>Home</small>
        </div>
        <div class="nav-item" onclick="startExercise()">
            üí™<br><small>Exercise</small>
        </div>
    </div>

    <script>
        let state = {
            availableMinutes: 0,
            blockedApps: [],
            currentReps: 0
        };

        let video, canvas, ctx;
        let lastBrightness = 0;
        let motionCount = 0;
        let repState = 'up';
        let cameraReady = false;

        // Initialize
        function init() {
            loadState();
            renderAppList();
            updateDisplay();
            initCamera(); // Start camera immediately in background
        }

        // Initialize camera in background
        async function initCamera() {
            try {
                video = document.getElementById('video');
                canvas = document.createElement('canvas');
                ctx = canvas.getContext('2d');
                canvas.width = 160;
                canvas.height = 120;
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: 640, height: 480 }
                });
                video.srcObject = stream;
                cameraReady = true;
                console.log('Camera ready!');
            } catch (e) {
                console.log('Camera not available');
            }
        }

        // Pick app from phone
        async function pickApp() {
            if (typeof Android !== 'undefined' && Android.getInstalledApps) {
                const appsJson = Android.getInstalledApps();
                const apps = JSON.parse(appsJson);
                
                // Simple selection (you can make this fancier)
                const appName = prompt("Enter app name from list:\n\n" + 
                    apps.slice(0, 20).map(a => a.name).join('\n'));
                
                if (appName) {
                    const app = apps.find(a => a.name.toLowerCase().includes(appName.toLowerCase()));
                    if (app && !state.blockedApps.find(a => a.package === app.package)) {
                        state.blockedApps.push(app);
                        saveState();
                        renderAppList();
                    }
                }
            }
        }

        // Render app list
        function renderAppList() {
            const list = document.getElementById('appList');
            list.innerHTML = state.blockedApps.map((app, i) => `
                <div class="app-item blocked" onclick="toggleApp(${i})">
                    <span>${app.name}</span>
                    <div class="toggle active"></div>
                </div>
            `).join('');
        }

        // Toggle app
        function toggleApp(index) {
            if (confirm('Remove ' + state.blockedApps[index].name + '?')) {
                state.blockedApps.splice(index, 1);
                saveState();
                renderAppList();
            }
        }

        // Start exercise
        function startExercise() {
            state.currentReps = 0;
            document.getElementById('repCount').textContent = '0';
            document.getElementById('earnedMins').textContent = '0';
            showScreen('exerciseScreen');
            
            if (cameraReady) {
                document.getElementById('cameraContainer').classList.add('active');
                startMotionDetection();
            }
        }

        // Better motion detection
        function startMotionDetection() {
            setInterval(() => {
                if (!video || video.readyState !== video.HAVE_ENOUGH_DATA) return;
                
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // Calculate brightness
                let totalBrightness = 0;
                for (let i = 0; i < imageData.data.length; i += 4) {
                    totalBrightness += (imageData.data[i] + imageData.data[i+1] + imageData.data[i+2]) / 3;
                }
                const avgBrightness = totalBrightness / (imageData.data.length / 4);
                
                // Detect motion
                const diff = Math.abs(avgBrightness - lastBrightness);
                
                if (diff > 15) { // Increased threshold
                    motionCount++;
                    if (motionCount > 3 && repState === 'up') {
                        repState = 'down';
                    }
                } else if (diff < 5) {
                    if (motionCount > 3 && repState === 'down') {
                        incrementRep();
                        repState = 'up';
                        motionCount = 0;
                    }
                }
                
                lastBrightness = avgBrightness;
            }, 300); // Slower for better accuracy
        }

        // Increment rep
        function incrementRep() {
            state.currentReps++;
            document.getElementById('repCount').textContent = state.currentReps;
            document.getElementById('earnedMins').textContent = state.currentReps;
        }

        // Complete exercise
        function completeExercise() {
            if (state.currentReps === 0) {
                alert('Do at least 1 rep!');
                return;
            }
            state.availableMinutes += state.currentReps;
            saveState();
            updateDisplay();
            stopExercise();
            alert(`+${state.currentReps} minutes earned!`);
            showScreen('homeScreen');
        }

        // Stop exercise
        function stopExercise() {
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(t => t.stop());
                video.srcObject = null;
                cameraReady = false;
                initCamera(); // Restart camera in background
            }
            document.getElementById('cameraContainer').classList.remove('active');
        }

        // Save/load state
        function saveState() {
            localStorage.setItem('fitblock_state', JSON.stringify(state));
            if (typeof Android !== 'undefined' && Android.setState) {
                Android.setState(JSON.stringify(state));
            }
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('fitblock_state');
                if (saved) state = {...state, ...JSON.parse(saved)};
                
                if (typeof Android !== 'undefined' && Android.getState) {
                    const androidState = Android.getState();
                    if (androidState) state = {...state, ...JSON.parse(androidState)};
                }
            } catch (e) {}
        }

        function updateDisplay() {
            document.getElementById('timeDisplay').textContent = state.availableMinutes;
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if (screenId === 'homeScreen') document.querySelectorAll('.nav-item')[0].classList.add('active');
        }

        window.addEventListener('load', init);
        setInterval(() => { if (typeof Android !== 'undefined') loadState(); }, 2000);
    </script>
</body>
</html>
